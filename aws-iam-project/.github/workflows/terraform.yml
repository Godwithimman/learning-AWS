# =============================================================
# .github/workflows/terraform.yml
# -------------------------------------------------------------
# PURPOSE: Automatically validate and plan Terraform changes
#          whenever someone opens a Pull Request on GitHub.
#
# ğŸ“– LEARN: CI/CD = Continuous Integration / Continuous Deployment
#           This workflow automatically:
#           1. Checks your code formatting
#           2. Validates the Terraform syntax
#           3. Shows what WOULD be created (plan)
#           4. Posts the plan as a PR comment
# =============================================================

name: ğŸ” Terraform IAM CI/CD

# Trigger: Run this workflow when...
on:
  push:
    branches:
      - main        # On every push to main branch
  pull_request:
    branches:
      - main        # On every Pull Request targeting main

# Permissions needed for OIDC authentication with AWS
permissions:
  id-token: write     # Required for OIDC
  contents: read      # Required to checkout code
  pull-requests: write # Required to post PR comments

jobs:
  # -------------------------------------------------------
  # JOB 1: Validate â€” Check code quality
  # -------------------------------------------------------
  validate:
    name: âœ… Validate Terraform
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: ğŸ“‹ Check Formatting
        run: terraform fmt -check -recursive
        # Fails if code isn't properly formatted
        # Fix locally with: terraform fmt -recursive

      - name: ğŸ” Initialize Terraform
        run: terraform init -backend=false
        # -backend=false skips remote state in CI

      - name: âœ… Validate Syntax
        run: terraform validate


  # -------------------------------------------------------
  # JOB 2: Plan â€” Show what would change (on Pull Requests)
  # -------------------------------------------------------
  plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      # Authenticate to AWS using OIDC (no credentials stored!)
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: ğŸ” Terraform Init
        run: terraform init

      - name: ğŸ“‹ Terraform Plan
        id: plan
        run: terraform plan -no-color -out=tfplan
        continue-on-error: true  # Don't fail if plan has issues

      # Post the plan as a comment on the Pull Request
      - name: ğŸ’¬ Post Plan to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `## ğŸ” Terraform IAM Plan
            **Status:** ${{ steps.plan.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}

            <details><summary>ğŸ“‹ Show Plan Output</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pushed by @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });


  # -------------------------------------------------------
  # JOB 3: Apply â€” Only runs on push to main (after PR merge)
  # -------------------------------------------------------
  # apply:
  #   name: ğŸš€ Terraform Apply
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   environment: production  # Requires manual approval in GitHub settings
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: hashicorp/setup-terraform@v3
  #     - uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
  #         aws-region: us-east-1
  #     - run: terraform init
  #     - run: terraform apply -auto-approve
